<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Section</title>
    
    <link rel="stylesheet" href="css/quiz.css"> 
    <link rel="stylesheet" href="css/header.css"> 
    <link rel="stylesheet" href="css/footer.css"> 
    <link rel="stylesheet" href="css/chatbot.css"> 
    <script src="/script/header.js" defer></script>
    <script src="/script/footer.js" defer></script>
    <script src="/script/chatbot.js" defer></script>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
</head>
<body id="quiz-page">  

    <div id="quiz-container">
    <div id="score-popup" class="score-popup">+50</div>

        <h2 id="quiz-title">Quiz Time!</h2>
        <p id="quiz-question"></p>
        <div id="quiz-options"></div>
        <p id="quiz-feedback"></p>
        <button id="quiz-nextBtn" style="display:none;" onclick="nextQuestion()">Next</button>
    </div>

    <div id="chatbot-placeholder"></div>

    <script>
        const quizData = [
            {
            question: "Hva handler gr√∏nn kode hovedsakelig om?",
            options: [
                "√Ö bruke mange farger i design",
                "√Ö skrive kode med mindre str√∏mforbruk",
                "√Ö bruke nyeste teknologi",
                "√Ö kode kun for gr√∏nne bedrifter"
            ],
            correct: "√Ö skrive kode med mindre str√∏mforbruk"
        },
        {
            question: "Hvilket tiltak bidrar mest til energieffektiv frontend?",
            options: [
                "Bruk av store bakgrunnsbilder",
                "Animasjoner i h√∏y oppl√∏sning",
                "Lazy loading av bilder og innhold",
                "Autoplay av videoer"
            ],
            correct: "Lazy loading av bilder og innhold"
        },
        {
            question: "Hva kan du gj√∏re i backend for √• redusere milj√∏avtrykket?",
            options: [
                "√òke antall serverkall",
                "Bruke polling i stedet for events",
                "Cache ofte brukte data",
                "Bruke st√∏rre databaser"
            ],
            correct: "Cache ofte brukte data"
        },
        {
            question: "Hvilken teknologi er kjent for √• bruke fornybar energi i sine datasentre?",
            options: [
                "AWS",
                "Google Cloud",
                "DigitalOcean",
                "GitHub"
            ],
            correct: "Google Cloud"
        },
        {
            question: "Hvilket av disse prinsippene er IKKE en del av gr√∏nn koding?",
            options: [
                "Redusere dataoverf√∏ring",
                "Optimalisere algoritmer",
                "Bruke s√• mye RAM som mulig",
                "Minimere lastetid"
            ],
            correct: "Bruke s√• mye RAM som mulig"
        }
        ];

        let currentQuestionIndex = 0;
        let answered = false;
        let loggedInUserId = null;

        // üîπ Sjekk session f√∏rst
        async function checkSession() {
            try {
                const response = await fetch("/api/users/session", {
                    method: "GET",
                    credentials: "include"
                });

                if (!response.ok) throw new Error("Ikke innlogget");

                const data = await response.json();
                loggedInUserId = data.userId;
            } catch (err) {
                alert("Du m√• v√¶re logget inn for √• ta quizen.");
                window.location.href = "login.html";
            }
        }

        async function loadQuestion() {
            answered = false;
            const questionEl = document.getElementById("quiz-question");
            const optionsEl = document.getElementById("quiz-options");
            const feedbackEl = document.getElementById("quiz-feedback");
            const nextBtn = document.getElementById("quiz-nextBtn");

            feedbackEl.textContent = "";
            nextBtn.style.display = "none";

            const questionData = quizData[currentQuestionIndex];
            questionEl.textContent = questionData.question;
            optionsEl.innerHTML = "";

            questionData.options.forEach(option => {
                const button = document.createElement("button");
                button.textContent = option;
                button.classList.add("quiz-option-btn");
                button.onclick = () => checkAnswer(button, questionData.correct);
                optionsEl.appendChild(button);
            });
        }

        async function checkAnswer(button, correctAnswer) {
        if (answered) return;
        answered = true;

        const feedback = document.getElementById("quiz-feedback");
        const nextBtn = document.getElementById("quiz-nextBtn");
        const buttons = document.querySelectorAll("#quiz-options button");

        buttons.forEach(btn => btn.disabled = true);

        if (button.innerText === correctAnswer) {
            feedback.textContent = "Riktig! üéâ";
            feedback.style.color = "green";

            // üîπ Vis poeng-popup og oppdater score
            showScorePopup();
            await increaseScore();
        } else {
            feedback.textContent = "Feil! ‚ùå";
            feedback.style.color = "red";
        }

        // üîπ Uansett om riktig eller feil ‚Äì vis neste-knapp
        nextBtn.style.display = "block";
    }
        async function increaseScore() {
            try {
                const response = await fetch("/api/score/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({
                        userId: loggedInUserId,
                        score: 50,
                        achievements: ["Quiz Bonus"]
                    })
                });

                if (!response.ok) {
                    console.error("‚ùå Kunne ikke oppdatere score");
                }
            } catch (err) {
                console.error("‚ö†Ô∏è Feil under poengoppdatering:", err);
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                loadQuestion();
            } else {
                document.getElementById("quiz-container").innerHTML = "<h2>Gratulerer, du har fullf√∏rt quizen! üéâ</h2>";
            }
        }

        // üöÄ Starter n√•r siden lastes
        checkSession().then(loadQuestion);

        function showScorePopup() {
            const popup = document.getElementById("score-popup");
            popup.classList.add("show");
            
            setTimeout(() => {
                popup.classList.remove("show");
            }, 500); // Skjul etter 0.5 sekund
        }
    </script>
</body>
</html>
