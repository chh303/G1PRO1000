<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Section</title>
    
    <link rel="stylesheet" href="css/quiz.css"> 
    <link rel="stylesheet" href="css/header.css"> 
    <link rel="stylesheet" href="css/footer.css"> 
    <link rel="stylesheet" href="css/chatbot.css"> 
    <script src="/script/header.js" defer></script>
    <script src="/script/footer.js" defer></script>
    <script src="/script/chatbot.js" defer></script>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
</head>
<body id="quiz-page">  

    <div id="quiz-container">
    <div id="score-popup" class="score-popup">+50</div>

        <h2 id="quiz-title">Quiz Time!</h2>
        <p id="quiz-question"></p>
        <div id="quiz-options"></div>
        <p id="quiz-feedback"></p>
        <button id="quiz-nextBtn" style="display:none;" onclick="nextQuestion()">Next</button>
    </div>

    <div id="chatbot-placeholder"></div>

    <script>
        const quizData = [
            {
                question: "Hva er hovedstaden i Frankrike?",
                options: ["Berlin", "Madrid", "Paris", "Roma"],
                correct: "Paris"
            },
            {
                question: "Hva er 5 + 3?",
                options: ["5", "8", "10", "15"],
                correct: "8"
            }
        ];

        let currentQuestionIndex = 0;
        let answered = false;
        let loggedInUserId = null;

        // üîπ Sjekk session f√∏rst
        async function checkSession() {
            try {
                const response = await fetch("/api/users/session", {
                    method: "GET",
                    credentials: "include"
                });

                if (!response.ok) throw new Error("Ikke innlogget");

                const data = await response.json();
                loggedInUserId = data.userId;
            } catch (err) {
                alert("Du m√• v√¶re logget inn for √• ta quizen.");
                window.location.href = "login.html";
            }
        }

        async function loadQuestion() {
            answered = false;
            const questionEl = document.getElementById("quiz-question");
            const optionsEl = document.getElementById("quiz-options");
            const feedbackEl = document.getElementById("quiz-feedback");
            const nextBtn = document.getElementById("quiz-nextBtn");

            feedbackEl.textContent = "";
            nextBtn.style.display = "none";

            const questionData = quizData[currentQuestionIndex];
            questionEl.textContent = questionData.question;
            optionsEl.innerHTML = "";

            questionData.options.forEach(option => {
                const button = document.createElement("button");
                button.textContent = option;
                button.classList.add("quiz-option-btn");
                button.onclick = () => checkAnswer(button, questionData.correct);
                optionsEl.appendChild(button);
            });
        }

        async function checkAnswer(button, correctAnswer) {
            if (answered) return;
            answered = true;

            const feedback = document.getElementById("quiz-feedback");
            const nextBtn = document.getElementById("quiz-nextBtn");
            const buttons = document.querySelectorAll("#quiz-options button");

            buttons.forEach(btn => btn.disabled = true);

            if (button.innerText === correctAnswer) {
                feedback.textContent = "Riktig! üéâ";
                feedback.style.color = "green";
                nextBtn.style.display = "block";

                // üîπ Vis +50 popup
                showScorePopup();

                // üîπ Oppdater poeng
                await increaseScore();
            }else {
                feedback.textContent = "Feil! ‚ùå";
                feedback.style.color = "red";
            }
        }

        async function increaseScore() {
            try {
                const response = await fetch("/api/score/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({
                        userId: loggedInUserId,
                        score: 50,
                        achievements: ["Quiz Bonus"]
                    })
                });

                if (!response.ok) {
                    console.error("‚ùå Kunne ikke oppdatere score");
                }
            } catch (err) {
                console.error("‚ö†Ô∏è Feil under poengoppdatering:", err);
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                loadQuestion();
            } else {
                document.getElementById("quiz-container").innerHTML = "<h2>Gratulerer, du har fullf√∏rt quizen! üéâ</h2>";
            }
        }

        // üöÄ Starter n√•r siden lastes
        checkSession().then(loadQuestion);

        function showScorePopup() {
            const popup = document.getElementById("score-popup");
            popup.classList.add("show");
            
            setTimeout(() => {
                popup.classList.remove("show");
            }, 2000); // Skjul etter 2 sekunder
        }
    </script>
</body>
</html>
