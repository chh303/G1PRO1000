<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Foruminnlegg</title>
    <link rel="stylesheet" href="css/forumPostDetails.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/chatbot.css">
    <script src="/script/header.js" defer></script>
    <script src="/script/footer.js" defer></script>
    <script src="/script/chatbot.js" defer></script>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="forum-detail-container">
        <h2 id="detail-title"></h2>
        <p id="detail-author"></p>
        <p id="detail-content"></p>
        <small id="detail-timestamp"></small>

        <h3>Kommentarer</h3>
        <div id="comment-list"></div>

        <h4>Legg igjen en kommentar</h4>
        <textarea id="comment-text" rows="4" cols="50"></textarea><br>
        <button onclick="submitComment()">Kommenter</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const postId = params.get("id");

        async function checkLoginStatus() {
            try {
                const response = await fetch("/api/users/session", {
                    credentials: "include"
                });

                if (!response.ok) {
                    throw new Error("Ikke logget inn");
                }

                const user = await response.json();
                console.log("✅ Bruker innlogget som:", user.username);
            } catch (err) {
                alert("Du må være logget inn for å lese og kommentere innlegg.");
                window.location.href = "/login.html";
            }
        }

        async function loadPost() {
            const res = await fetch(`/api/forum/${postId}`, {
                credentials: "include"
            });
            const post = await res.json();

            document.getElementById("detail-title").innerText = post.title;
            document.getElementById("detail-author").innerText = "Skrevet av: " + post.author;
            document.getElementById("detail-content").innerText = post.content;
            document.getElementById("detail-timestamp").innerText = new Date(post.timestamp).toLocaleString();
        }

        async function loadComments() {
            const res = await fetch(`/api/comments/post/${postId}`, {
                credentials: "include"
            });
            const comments = await res.json();

            const commentList = document.getElementById("comment-list");
            commentList.innerHTML = "";

            comments.forEach(c => {
                const commentEl = document.createElement("div");
                commentEl.classList.add("comment");
                commentEl.innerHTML = `
                    <p><strong>${c.author}</strong></p>
                    <p>${c.content}</p>
                    <small>${new Date(c.timestamp).toLocaleString()}</small>
                    <hr>
                `;
                commentList.appendChild(commentEl);
            });
        }

        async function submitComment() {
            const text = document.getElementById("comment-text").value.trim();

            if (!text) {
                alert("Kommentaren kan ikke være tom.");
                return;
            }

            const response = await fetch(`/api/comments/add/${postId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(text)
            });

            if (response.ok) {
                document.getElementById("comment-text").value = "";
                loadComments();
            } else {
                alert("Du må være logget inn for å kommentere.");
                window.location.href = "/login.html";
            }
        }

        // Først: sjekk innlogging → deretter last data
        checkLoginStatus().then(() => {
            loadPost();
            loadComments();
        });
    </script>
</body>
</html>
