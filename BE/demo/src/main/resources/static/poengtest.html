<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poengtest</title>
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/footer.css" />
    <link rel="stylesheet" href="css/chatbot.css" />
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" />
  
    <script src="/script/header.js" defer></script>
    <script src="/script/footer.js" defer></script>
    <script src="/script/chatbot.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; text-align: center; }
        .container { max-width: 400px; margin: auto; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Velkommen, <span id="usernameDisplay">[Brukernavn]</span>!</h2>
        <p>Din poengsum: <span id="scoreDisplay">0</span></p>

        <button onclick="increaseScore()">√òk poeng med 50</button>
        <p id="message"></p>

        <button onclick="logout()">Logg ut</button>
    </div>

    <script>
        let loggedInUserId;
        let loggedInUsername;

        // üöÄ Sjekker om brukeren er innlogget via session
        async function checkSession() {
            try {
                const response = await fetch("/api/users/session", {
                    method: "GET",
                    credentials: "include" // üîπ S√∏rger for at session-cookie sendes med
                });

                if (!response.ok) {
                    throw new Error("Ikke innlogget");
                }

                const userData = await response.json();
                if (!userData.loggedIn) {
                    throw new Error("Ikke innlogget");
                }

                loggedInUserId = userData.userId;
                loggedInUsername = userData.username;

                document.getElementById("usernameDisplay").innerText = loggedInUsername;
                getUserScore();

            } catch (error) {
                console.log("‚ùå Bruker ikke innlogget. Sender til login.");
                window.location.href = "login.html"; // üöÄ Sender brukeren til login hvis ikke innlogget
            }
        }

        // üöÄ Henter poengsum
        async function getUserScore() {
            const response = await fetch(`/api/score/${loggedInUserId}`, { credentials: "include" });

            if (response.ok) {
                const userScore = await response.json();
                console.log("Hentet score:", userScore);
                document.getElementById("scoreDisplay").innerText = userScore.score;
            } else {
                console.log("Kunne ikke hente score");
                document.getElementById("scoreDisplay").innerText = "0";
            }
        }

        // üöÄ √òker poeng
        async function increaseScore() {
            const response = await fetch("/api/score/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include", // üîπ Sikrer at session-cookie sendes med
                body: JSON.stringify({
                    userId: loggedInUserId,
                    score: 50,
                    achievements: ["Bonus 50"]
                })
            });

            if (response.ok) {
                getUserScore();
            } else {
                const errorData = await response.text();
                alert("Kunne ikke oppdatere score: " + errorData);
            }
        }

        // üöÄ Logg ut
        async function logout() {
            await fetch("/api/users/logout", { method: "POST", credentials: "include" });
            window.location.href = "login.html";
        }

        // üöÄ Start ved √• sjekke om brukeren er logget inn
        checkSession();
    </script>

    <div id="chatbot-placeholder"></div>

</body>
</html>
